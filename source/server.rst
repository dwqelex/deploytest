===============================
337移动支付服务端回调及验证说明
===============================
概述
----

在用户支付完成之后，支付平台会将支付结果通知到应用提供的回调地址，应用接收到回调后，应该根据结果给用户提供相应的商品，并给支付平台返回一个事先约定好的结果。至此一笔交易在支付平台才算完成。

当应用没有返回要求的结果时，支付平台最多会回调3次，3次不成功之后，当前交易会被设置为失败交易，之后会有客服介入，手动处理失败交易。

为了保证应用方收到的数据是由支付平台发送而非第三方伪造，支付平台提供了二次验证的方式，应用服务端在收到回调通知之后，可以拿收到的数据到支付平台提供的接口进行验证，若验证通过，则说明该通知真实可信。

回调环节
--------

应用需要提供一个回调地址来接收回调参数

支付平台会使用post方式发送以下参数：

* trans_id：交易流水号，该交易在支付平台生成的唯一id
* amount：道具数量，该值由前端传递而来
* user_id：完成支付的玩家id，该值由前端传递而来
* timestamp：时间戳
* gross：交易金额
* currency：货币类型代码，比如USD(美元)、CNY(人民币)、BRL(巴西雷亚尔)
* channel：渠道名称，比如alipay、paypal、mycard
* item：商品描述，该值由前端传递而来
* custom_data：应用方的自定义字段，由前端传递而来
* product_id：应用方定义的商品id，由前端传递而来
* pay_type：交易类型，移动端该值为mobile
* role_id：角色id

支付平台需要应用服务端返回以下规则的字符串：

* 3,null：表示游戏方处理失败
* 3,94a0acb127ef8ee8c925e3944941ce5e：表示游戏方不认识这个玩家id
* 3,user_id：表示处理成功，比如回调时，user_id为123456，那么游戏方的返回值应该为3,123456

如果3次回调后应用服务端未按规则返回，则该交易失败，等待客服处理。

安全验证
--------

安全验证机制可以保证应用服务端收到的回调确实是由支付平台发起而非第三方伪造。

具体的验证方法详见：https://code.google.com/p/elexpublish/wiki/Payment/howto#验证交易信息